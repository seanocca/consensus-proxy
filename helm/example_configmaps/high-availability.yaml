# High-availability deployment
# Multiple replicas with PDB, pod anti-affinity, and topology spread
# for production workloads that cannot tolerate downtime.

namespace:
  name: consensus-proxy
  create: true

deployment:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1

podDisruptionBudget:
  enabled: true
  minAvailable: 2

horizontalPodAutoscaler:
  enabled: true
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 75
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max

resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: "1"
    memory: 1Gi

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - consensus-proxy
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: consensus-proxy

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65534
  fsGroup: 65534

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

configMap:
  config: |
    [server]
    port = 8080
    read_timeout = "30s"
    write_timeout = "30s"
    max_retries = 3
    request_timeout = "30s"
    idle_timeout = "90s"
    read_header_timeout = "10s"

    [beacons]
    nodes = ["lighthouse-1", "lighthouse-2", "prysm-1"]

    [beacons.lighthouse-1]
    url = "http://lighthouse-1:5052"
    type = "lighthouse"

    [beacons.lighthouse-2]
    url = "http://lighthouse-2:5052"
    type = "lighthouse"

    [beacons.prysm-1]
    url = "http://prysm-1:3500"
    type = "prysm"

    [failover]
    error_threshold = 3

    [metrics]
    enabled = true
    namespace = "consensus_proxy"

    [logger]
    level = "info"
    format = "json"
    output = "stdout"

    [ratelimit]
    enabled = true
    requests_per_second = 500
    window = "1m"
    cleanup_interval = "5m"
    client_expiry = "10m"

    [proxy]
    user_agent = "consensus-proxy/1.0"
    max_idle_connections = 200
    idle_connection_timeout = "90s"
    max_idle_connections_per_host = 50
    max_connections_per_host = 200
    response_header_timeout = "10s"
    tls_handshake_timeout = "10s"
    expect_continue_timeout = "1s"

    [health]
    interval = "15s"
    timeout = "5s"
    successful_checks_for_failback = 5
